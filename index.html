<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>CSB Şube Müdürlüğü Kentsel Bilgi Sistemi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body, #map { margin: 0; height: 100%; }

  .search-box {
  position: absolute;
  top: 12px;
  left: 60px; /* Zoom butonlarından uzak */
  z-index: 1000;
  background: white;
  padding: 6px 10px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: nowrap;
  max-width: calc(100% - 120px); /* mobilde taşmayı önler */
  min-width: 250px;
}
    .label-text {
      font-size: 10px;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px black;
      text-align: center;
    }

    .legend {
      position: absolute;
      bottom: 20px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      font-size: 12px;
      line-height: 18px;
      border-radius: 4px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }

    .legend h4 { margin: 0 0 6px; font-size: 14px; }
    .legend div { display: flex; align-items: center; margin-bottom: 3px; }
    .legend span {
      display: inline-block;
      width: 20px;
      height: 12px;
      margin-right: 6px;
      border: 1px solid #000;
    }
  </style>
</head>
<body>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Ada-Parsel (örn: 123/45)" />
    <button onclick="searchParsel()">Ara</button>
  </div>

  <div class="legend">
    <h4>Kentsel Dönüşüm Alanları</h4>
    <div><span style="background:#00FF00"></span> 1 - 5393 EBB Yetkisinde</div>
    <div><span style="background:#FFA500"></span> 2 - 5393 EBB Yetkisi Dışında</div>
    <div><span style="background:#FF0000"></span> 3 - 6306 Riskli Alan</div>
    <div><span style="background:#0000FF"></span> 4 - 6036 Rezerv Alan</div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
  const map = L.map("map");

  // Esri Satellite altlığı
  const esriSat = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
      attribution: "Tiles © Esri"
    }
  );

  // OSM altlığı
  const osm = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 20,
      attribution: "© OpenStreetMap"
    }
  );

  // Başlangıçta OSM açık
 esriSat.addTo(map);

  // Altlık katmanlarını kullanıcı seçebilir
  const baseMaps = {
    "OSM Harita": osm,
    "Uydu ": esriSat
  };
  L.control.layers(baseMaps).addTo(map);

  let parselLayer, parselLabels = L.layerGroup(), kentselLabels = L.layerGroup();

  function createLabel(text, center) {
    return L.marker(center, {
      icon: L.divIcon({
        className: 'label-text',
        html: text,
        iconSize: null,
        iconAnchor: [0, 0]
      }),
      interactive: false
    });
  }

    // === KENTSEL ===
    fetch("data/KENTSEL.geojson")
      .then(res => res.json())
      .then(data => {
        const layer = L.geoJSON(data, {
          style: function (feature) {
            const renk = {
              1: "#00FF00",
              2: "#FFA500",
              3: "#FF0000",
              4: "#0000FF"
            }[feature.properties.tur] || "#999";
            return {
              fillColor: "#ffffff00",
              color: renk,
              weight: 6,
              opacity: 1
            };
          },
          onEachFeature: function (feature, layer) {
            const center = layer.getBounds().getCenter();
            const name = feature.properties.alan_adı || "İsimsiz Alan";
            kentselLabels.addLayer(createLabel(name, center));

            // Tüm öznitelikleri listele (tarih biçimi düzeltildi)
            const props = feature.properties;
            let popup = "<b>Öznitelik Bilgileri:</b><ul>";
            for (let key in props) {
              let value = props[key];
              if (key === "meclis_karar_tarih" && value) {
                try {
                  if (typeof value === "string" && value.includes("-")) {
                    const parts = value.split("T")[0].split("-");
                    if (parts.length === 3) {
                      value = `${parts[2]}.${parts[1]}.${parts[0]}`;
                    }
                  } else {
                    const date = new Date(value);
                    if (!isNaN(date)) {
                      const gun = String(date.getDate()).padStart(2, "0");
                      const ay = String(date.getMonth() + 1).padStart(2, "0");
                      const yil = date.getFullYear();
                      value = `${gun}.${ay}.${yil}`;
                    }
                  }
                } catch (e) {}
              }
              popup += `<li><b>${key}:</b> ${value}</li>`;
            }
            popup += "</ul>";
            layer.bindPopup(popup);
          }
        }).addTo(map);
        map.fitBounds(layer.getBounds());
      });

    // === PARSEL ===
    fetch("data/PARSEL.geojson")
      .then(res => res.json())
      .then(data => {
        parselLayer = L.geoJSON(data, {
          style: {
            color: "#cc0000",
            fillColor: "#ff9999",
            fillOpacity: 0.6,
            weight: 1
          },
          onEachFeature: function (feature, layer) {
            const center = layer.getBounds().getCenter();
            const label = feature.properties.ada_parsel;
            if (label) {
              parselLabels.addLayer(createLabel(label, center));
            }
            layer.bindPopup(`<b>${label}</b>`);
          }
        }).addTo(map);
      });

    // === ZOOM ile Etiket Kontrol ===
    map.on("zoomend", () => {
      const z = map.getZoom();
      if (z >= 17) {
        map.addLayer(parselLabels);
        map.addLayer(kentselLabels);
      } else {
        map.removeLayer(parselLabels);
        map.removeLayer(kentselLabels);
      }
    });

    // === ARAMA ===
    function searchParsel() {
      const input = document.getElementById("searchInput").value.trim();
      if (!input || !parselLayer) return alert("Ada/Parsel girin!");

      let found = false;
      parselLayer.eachLayer(layer => {
        const val = layer.feature.properties.ada_parsel;
        if (val && val.toString() === input) {
          map.fitBounds(layer.getBounds());
          layer.openPopup();
          alert("Kentsel Dönüşüm Alanındasınız");
          found = true;
        }
      });

      if (!found) alert("Parsel bulunamadı. Kentsel Dönüşüm Alanında Değilsiniz");
    }
  </script>
</body>
</html>
